<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AttendAce | Class Management</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles2.css">
</head>

<body class="font-sans max-w-[420px] mx-auto overflow-y-auto relative z-10">

<div id="bg-anim"></div>
<audio id="clickSound" src="https://assets.mixkit.co/sfx/preview/mixkit-game-click-1114.mp3"></audio>

<!-- HEADER -->
<header class="p-4 flex justify-between items-center reveal">
  <h1 class="font-black text-lg tracking-tight">Class Management</h1>
  <button id="themeToggle" class="px-4 py-2 rounded-full glass text-xs font-bold press">
    OFFICIAL
  </button>
</header>

<!-- PROFILE CARD -->
<section class="px-5 mt-2 reveal">
  <div class="glass p-5 flex justify-between items-center">
    <div>
      <p class="text-xs font-semibold text-[var(--accent)]" id="teacherId">ID: --</p>
      <h2 class="text-xl font-black mt-1" id="teacherName">Teacher</h2>
      <p class="text-xs text-[var(--muted)]" id="teacherDept">Department</p>
    </div>
    <button onclick="window.location.href='teacher-dashboard.html'"
      class="px-3 py-2 text-xs rounded-full glass press">
      ‚Üê Dashboard
    </button>
  </div>
</section>

<!-- ADD CLASS BUTTON -->
<section class="px-6 mt-5 reveal">
  <button id="openAddModal"
    class="menu-btn w-full rounded-xl p-4 text-lg font-semibold">
    + Add New Class
  </button>
</section>

<!-- CLASSES LIST -->
<section class="px-6 mt-4 flex flex-col gap-3 reveal pb-10" id="classesList">
  <div class="text-center text-sm opacity-60">Loading classes...</div>
</section>

<!-- ADD CLASS MODAL -->
<div id="addModal"
  class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">

  <div class="glass p-6 w-[90%] max-w-[350px]">
    <h3 class="text-xl font-bold mb-4">Add Class</h3>

    <input id="className"
      class="w-full p-3 mb-3 rounded-xl bg-transparent border border-gray-400 outline-none"
      placeholder="Class Name">

    <input id="subject"
      class="w-full p-3 mb-4 rounded-xl bg-transparent border border-gray-400 outline-none"
      placeholder="Subject">

    <button id="submitClass"
      class="hero-btn w-full py-3 rounded-xl font-bold">
      Add Class
    </button>

    <button id="closeModal"
      class="mt-3 w-full text-sm opacity-70">
      Cancel
    </button>

    <p id="modalMsg" class="text-sm mt-3"></p>
  </div>
</div>

<script>
const API = "https://attendace-zjzu.onrender.com/api/teacher";
const token = localStorage.getItem('token');
const clickSound = document.getElementById('clickSound');

document.querySelectorAll('button').forEach(b=>{
  b.addEventListener('click',()=>clickSound.play());
});

/* THEME */
const toggle = document.getElementById('themeToggle');
toggle.onclick = ()=>{
  document.body.classList.toggle('gaming');
  toggle.innerText = document.body.classList.contains('gaming')
    ? 'GAMING' : 'OFFICIAL';
};

/* FETCH PROFILE */
async function fetchProfile(){
  const res = await fetch(`${API}/profile`,{
    headers:{ Authorization:'Bearer '+token }
  });
  if(!res.ok){ window.location.href="login.html"; return; }
  const data = await res.json();
  localStorage.setItem('user',JSON.stringify(data.user));
  return data.user;
}

/* LOAD CLASSES */
async function fetchClasses(){
  const res = await fetch(`${API}/classes`,{
    headers:{ Authorization:'Bearer '+token }
  });
  const classes = await res.json();
  const container = document.getElementById('classesList');
  container.innerHTML='';

  if(!classes.length){
    container.innerHTML='<div class="text-center opacity-60">No classes found</div>';
    return;
  }

  classes.forEach(cls=>{
    const card=document.createElement('div');
    card.className="menu-btn p-4 rounded-xl flex flex-col gap-2";

    card.innerHTML=`
      <div class="flex justify-between items-center">
        <div>
          <div class="font-bold text-lg">${cls.name}</div>
          <div class="text-xs opacity-70">${cls.subject || ''}</div>
        </div>
        <button class="press px-3 py-2 rounded-full text-xs font-bold
          ${cls.is_active ? 'bg-red-500 text-white' : 'bg-green-600 text-white'}">
          ${cls.is_active ? 'Deactivate' : 'Activate'}
        </button>
      </div>
      <div class="text-xs opacity-70">
        ${cls.is_active ? 'Class is active' : ''}
      </div>
    `;

    const btn=card.querySelector('button');
    btn.onclick=()=>toggleClass(cls.id,btn);

    container.appendChild(card);
  });
}

/* ACTIVATE / DEACTIVATE */
async function toggleClass(id,btn){
  const isActive=btn.innerText==='Deactivate';

  const url=isActive?`${API}/classes/deactivate`:`${API}/classes/activate`;
  const body=isActive?{class_id:id}:{class_id:id,minutes:5};

  const res=await fetch(url,{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      Authorization:'Bearer '+token
    },
    body:JSON.stringify(body)
  });

  if(res.ok) fetchClasses();
}

/* ADD CLASS MODAL */
const modal=document.getElementById('addModal');
document.getElementById('openAddModal').onclick=()=>modal.classList.remove('hidden');
document.getElementById('closeModal').onclick=()=>modal.classList.add('hidden');

document.getElementById('submitClass').onclick=async()=>{
  const name=document.getElementById('className').value;
  const subject=document.getElementById('subject').value;
  const msg=document.getElementById('modalMsg');

  const res=await fetch(`${API}/classes/add`,{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      Authorization:'Bearer '+token
    },
    body:JSON.stringify({name,subject})
  });

  const data=await res.json();
  if(!res.ok){
    msg.innerText=data.message||"Error";
    msg.style.color="red";
    return;
  }

  msg.innerText="Class added successfully";
  msg.style.color="green";
  document.getElementById('className').value='';
  document.getElementById('subject').value='';
  fetchClasses();
};

/* INIT */
document.addEventListener('DOMContentLoaded',async()=>{
  const user=await fetchProfile();
  if(!user)return;

  document.getElementById('teacherName').innerText=user.name;
  document.getElementById('teacherId').innerText="ID: "+user.id;
  document.getElementById('teacherDept').innerText="Department: "+(user.department||"--");

  if(user.mode==='gaming'){
    document.body.classList.add('gaming');
    toggle.innerText='GAMING';
  }

  fetchClasses();
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings | AttendAce</title>
  <link rel="stylesheet" href="assets/styles2.css">
</head>
<body>
  <div class="container glass reveal">
    <header style="text-align:center;">
      <img src="assets/logo.png" alt="AttendAce Logo" class="logo">
      <h1>Settings</h1>
    </header>

    <form id="settingsForm" class="details-form">
      <div class="form-group">
        <label for="fullName">Full Name</label>
        <input type="text" id="fullName" class="glass" required>
      </div>
      <div class="form-group">
        <label for="userId">ID</label>
        <input type="text" id="userId" class="glass" readonly>
      </div>
      <div class="form-group">
        <label for="email">Email Address</label>
        <input type="email" id="email" class="glass" required>
      </div>
      <div class="form-group" id="departmentGroup">
        <label for="department">Department</label>
        <select id="department" class="glass" required>
          <option value="CSE">CSE</option>
          <option value="ECE">ECE</option>
          <option value="EE">EE</option>
          <option value="ME">ME</option>
          <option value="CIV">CIV</option>
        </select>
      </div>
      <div class="form-group">
        <label for="mode">Mode</label>
        <select id="mode" class="glass" required>
          <option value="gaming">Gaming</option>
          <option value="official">Official</option>
        </select>
      </div>
    </form>

    <div class="menu-options">
      <button type="button" class="menu-btn primary" id="saveBtn">‚úîÔ∏è Save Changes</button>
      <a href="#" class="menu-btn" id="backBtn">‚¨ÖÔ∏è Back to Dashboard</a>
      <button class="menu-btn danger" id="logoutBtn">üö™ Logout</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let user = localStorage.getItem('user');
      try { user = user && user !== 'undefined' ? JSON.parse(user) : null; } 
      catch { user = null; }
      const token = localStorage.getItem('token');
      if (!user || !token) return (window.location.href = 'login.html');

      // Apply mode class
      document.body.classList.remove('gaming');
      if (user.mode === 'gaming') document.body.classList.add('gaming');

      // Fill fields
      document.getElementById('fullName').value = user.name || '';
      document.getElementById('userId').value = user.id || '';
      document.getElementById('email').value = user.email || '';
      document.getElementById('mode').value = user.mode || 'official';

      const departmentGroup = document.getElementById('departmentGroup');
      const departmentSelect = document.getElementById('department');
      if (user.role !== 'student') {
        departmentGroup.style.display = 'none';
        departmentSelect.required = false;
      } else {
        departmentSelect.value = user.department || '';
      }

      // Save button
      document.getElementById('saveBtn').addEventListener('click', async () => {
        const updatedUser = {
          name: document.getElementById('fullName').value.trim(),
          email: document.getElementById('email').value.trim(),
          gender: user.gender || null,
          dob: user.dob || null,
          mode: document.getElementById('mode').value
        };
        if (user.role === 'student') updatedUser.department = departmentSelect.value;

        const endpoint = user.role === 'student'
          ? 'https://attendace-zjzu.onrender.com/api/student/update'
          : 'https://attendace-zjzu.onrender.com/api/teacher/update';

        try {
          const res = await fetch(endpoint, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
            body: JSON.stringify(updatedUser),
          });

          if (!res.ok) throw new Error('Update failed');
          const data = await res.json();
          if (data.user) {
            localStorage.setItem('user', JSON.stringify(data.user));
            // Apply new mode immediately
            document.body.classList.remove('gaming');
            if (data.user.mode === 'gaming') document.body.classList.add('gaming');
          }
          alert(data.message || 'Profile updated successfully');
        } catch (err) {
          console.error('Update error:', err);
          alert('Could not update profile');
        }
      });

      document.getElementById('backBtn').addEventListener('click', () => {
        window.location.href = user.role === 'student'
          ? 'student-dashboard.html'
          : 'teacher-dashboard.html';
      });

      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.clear();
        window.location.href = 'login.html';
      });
    });
  </script>
</body>
</html>